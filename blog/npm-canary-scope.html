<!DOCTYPE html><html lang="en"><head><style>
            :root {
              --color-primary-100: #F3E6ED;
              --color-primary-200: #E1BFD1;
              --color-primary-300: #CF99B6;
              --color-primary-400: #AB4D7F;
              --color-primary-500: #870048;
              --color-primary-600: #7A0041;
              --color-primary-700: #51002B;
              --color-primary-800: #3D0020;
              --color-primary-900: #290016;

              --color-gray-100: #f1eef0;
              --color-gray-200: #e3dde0;
              --color-gray-300: #d5cdd1;
              --color-gray-400: #c7bcc1;
              --color-gray-500: #b9abb2;
              --color-gray-600: #94898e;
              --color-gray-700: #6f676b;
              --color-gray-800: #4a4447;
              --color-gray-900: #252224;
              --color-gray-1000: #181617;
            }
          </style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css"/><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="shortcut icon" media="(prefers-color-scheme:dark)" href="/auto/favicon.png"/><title>npm: More Secure Canary Publishing</title><meta name="next-head-count" content="4"/><link rel="preload" href="/auto/_next/static/css/3a4538e7c5719b3a5ef7.css" as="style"/><link rel="stylesheet" href="/auto/_next/static/css/3a4538e7c5719b3a5ef7.css"/><link rel="preload" href="/auto/_next/static/css/240f51df4b0295ac6620.css" as="style"/><link rel="stylesheet" href="/auto/_next/static/css/240f51df4b0295ac6620.css"/><link rel="preload" href="/auto/_next/static/hUHIRsB3kRewdeO8JZHuh/pages/_app.js" as="script"/><link rel="preload" href="/auto/_next/static/hUHIRsB3kRewdeO8JZHuh/pages/blog/npm-canary-scope.js" as="script"/><link rel="preload" href="/auto/_next/static/runtime/webpack-c212667a5f965e81e004.js" as="script"/><link rel="preload" href="/auto/_next/static/chunks/framework.00c128824b7f421d9465.js" as="script"/><link rel="preload" href="/auto/_next/static/chunks/c0d60241.215143c264d3a1b830ef.js" as="script"/><link rel="preload" href="/auto/_next/static/chunks/fc57ec0e.f6541c4d9d596c2aef75.js" as="script"/><link rel="preload" href="/auto/_next/static/chunks/90ae4d623e43c2d3c5725a46451f3e6f5a5d945c.d1f24c5f6b2ef3a4bdd5.js" as="script"/><link rel="preload" href="/auto/_next/static/chunks/d7217cfdc2748b34172f813efa92e4207d39b759.d4bcde477e4fd173240e.js" as="script"/><link rel="preload" href="/auto/_next/static/chunks/8588f75bc776c9da618c7380ed92079ffdadc2a6.bca1fd0253a81db7d0c5.js" as="script"/><link rel="preload" href="/auto/_next/static/chunks/f09385b2ddc110a5a4c66d0b3055261d96711bfa.3bab86f518789fc7d1b9.js" as="script"/><link rel="preload" href="/auto/_next/static/chunks/35a5a53e27ffb1834d727be2d63ceac929300aa9.84e77ed39b387b80f63b.js" as="script"/><link rel="preload" href="/auto/_next/static/runtime/main-efba08c5bc5b06864400.js" as="script"/><link rel="preload" href="/auto/_next/static/chunks/89db983f2c4b9451dcd29b173f3ed16227e1f88d.0199175a2d64b0ba10d8.js" as="script"/></head><body><script src="/auto/attach-dark-mode.js"></script><div id="__next"><div id="ignite" class="min-h-screen flex flex-col dark:bg-gray-1000"><div class="border-b border-grey-200 lg:mx-0 dark:border-gray-900"><div class="h-16 max-w-screen-xl mx-auto w-full flex justify-between items-center"><a tabindex="0" class="text-gray-800 dark:text-gray-300 px-6 h-full focus:outline-none flex items-center font-normal cursor-pointer text-xl md:pr-10 lg:w-1/5" href="/auto/"><picture class="md:mr-3"><source srcSet="/auto/logo-dark.png" media="(prefers-color-scheme: dark)" class="w-8 h-8"/><img src="/auto/logo.png" alt="auto Logo" class="w-8 h-8"/></picture><span class="hidden uppercase font-semibold tracking-widest text-sm md:block dark:text-gray-200">auto</span></a><div class="w-full h-full flex items-center lg:flex flex-1 lg:max-w-screen-md lg:mx-auto"><div class="relative h-full flex items-center w-full lg:w-auto lg:flex-1 lg:mr-4 px-4"><input id="search" autoComplete="off" placeholder="Search (Press &quot;/&quot; to focus)" class="text-gray-800 dark:text-gray-300 placeholder-gray-500 rounded border-2 border-gray-200 bg-gray-200 px-4 py-2 w-full focus:bg-white focus:outline-none dark-placeholder:placeholder-gray-600 dark:bg-gray-900 dark:border-gray-900 dark-focus:bg-gray-1000 dark-focus:border-gray-800 dark-focus:text-white"/></div><button class="text-gray-700 px-6 hover:text-primary-600 focus:text-primary-600 focus:outline-none dark:text-gray-400 lg:hidden"><svg class="fill-current w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path></svg></button><div class="hidden lg:flex h-full"><a tabindex="0" class="justify-center h-full flex items-center px-6 py-4 cursor-pointer text-gray-700 hover:bg-gray-200 hover:text-primary-600 focus:bg-gray-200 focus:text-primary-600 focus:outline-none dark:text-gray-400 dark-hover:bg-gray-900 dark-hover:text-white dark-focus:bg-gray-1000 dark-focus:text-white" href="/auto/docs"><div class="flex items-center">Docs</div></a><a tabindex="0" class="justify-center h-full flex items-center px-6 py-4 cursor-pointer text-gray-700 hover:bg-gray-200 hover:text-primary-600 focus:bg-gray-200 focus:text-primary-600 focus:outline-none dark:text-gray-400 dark-hover:bg-gray-900 dark-hover:text-white dark-focus:bg-gray-1000 dark-focus:text-white" href="/auto/blog"><div class="flex items-center">Blog</div></a><a tabindex="0" class="justify-center h-full flex items-center px-6 py-4 cursor-pointer text-gray-700 hover:bg-gray-200 hover:text-primary-600 focus:bg-gray-200 focus:text-primary-600 focus:outline-none dark:text-gray-400 dark-hover:bg-gray-900 dark-hover:text-white dark-focus:bg-gray-1000 dark-focus:text-white" href="https://github.com/intuit/auto" target="_blank" aria-label="Open on GitHub"><div class="flex items-center"><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 0a10 10 0 0 0-3.16 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94 0-1.1.39-1.99 1.03-2.69a3.6 3.6 0 0 1 .1-2.64s.84-.27 2.75 1.02a9.58 9.58 0 0 1 5 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69 0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0 0 10 0"></path></svg></div></a></div></div></div></div><div class="bg-primary-500 bg-cover bg-no-repeat bg-center h-screen" style="max-height:30vh;min-height:315px;background-image:url(https://images.unsplash.com/photo-1566386087068-55645996b234?crop=entropy&amp;cs=tinysrgb&amp;fit=crop&amp;fm=jpg&amp;h=500&amp;ixid=eyJhcHBfaWQiOjF9&amp;ixlib=rb-1.2.1&amp;q=80&amp;w=1950)"></div><article class="DocSearch-content blog-post pt-6 pb-12 px-6 w-full max-w-screen-sm mx-auto rounded -mt-10 bg-white shadow-md text-gray-800 lg:max-w-screen-md dark:bg-gray-900"><div class="max-w-screen-sm lg:max-w-screen-md mx-auto text-center flex flex-col items-center"><img src="//www.gravatar.com/avatar/ff725a631f869cdb78beeb003825bb40" class="rounded-full w-12 border-2 border-gray-200 dark:border-gray-900 -mt-12 mb-4"/><h1 class="text-3xl font-light mb-4 dark:text-gray-200">npm: More Secure Canary Publishing</h1><p class="mb-6"><span class="dark:text-gray-300">Andrew Lisowski</span> <span class="text-gray-600">on <!-- -->3/12/20</span></p></div><p class="my-4 text-gray-800 dark:text-gray-300">Publishing canary versions comes with some security risks.
If your project is private you have nothing to worry about, but if your project is open source there are some security holes.</p><h2 class="lvl2 relative text-3xl font-normal border-b border-gray-300 pb-4 mb-8 mt-12 dark:border-gray-700 text-gray-900 dark:text-gray-200" id="attack-vectors"><a class="header-link no-underline text-gray-900&quot; hover:underline" href="#attack-vectors">Attack Vectors</a></h2><p class="my-4 text-gray-800 dark:text-gray-300">Depending on the build platform you might be able to pass secrets to PR builds for forked repos.
While this makes the developer experience of your project nice, in <code class="text-gray-700 bg-gray-200 rounded dark:bg-gray-800 dark:text-gray-300" style="padding:2px 6px">auto</code>&#x27;s case publishing canary versions, it exposes your keys.</p><p class="my-4 text-gray-800 dark:text-gray-300">An attacker could:</p><ol class="my-6 ol"><li class="my-4 text-gray-800 dark:text-gray-300">print secrets</li><li class="my-4 text-gray-800 dark:text-gray-300">send secrets to some server</li><li class="my-4 text-gray-800 dark:text-gray-300">modify <code class="text-gray-700 bg-gray-200 rounded dark:bg-gray-800 dark:text-gray-300" style="padding:2px 6px">auto</code> to publish to the latest tag instead of <code class="text-gray-700 bg-gray-200 rounded dark:bg-gray-800 dark:text-gray-300" style="padding:2px 6px">canary</code></li></ol><p class="my-4 text-gray-800 dark:text-gray-300">No amount of code can fix these problems.
If your release keys are in everyone&#x27;s CI builds an attacker can do any number of things to modify what you intend for <code class="text-gray-700 bg-gray-200 rounded dark:bg-gray-800 dark:text-gray-300" style="padding:2px 6px">auto</code> to do (or any other release method run in the CI).</p><h2 class="lvl2 relative text-3xl font-normal border-b border-gray-300 pb-4 mb-8 mt-12 dark:border-gray-700 text-gray-900 dark:text-gray-200" id="solution"><a class="header-link no-underline text-gray-900&quot; hover:underline" href="#solution">Solution</a></h2><p class="my-4 text-gray-800 dark:text-gray-300">The solution for this is actually quite simple:</p><ol class="my-6 ol"><li class="my-4 text-gray-800 dark:text-gray-300">Create a test scope that you publish canaries under (ex: <code class="text-gray-700 bg-gray-200 rounded dark:bg-gray-800 dark:text-gray-300" style="padding:2px 6px">@auto-canary</code> or <code class="text-gray-700 bg-gray-200 rounded dark:bg-gray-800 dark:text-gray-300" style="padding:2px 6px">@auto-test</code>)</li><li class="my-4 text-gray-800 dark:text-gray-300">Create a user that only has access to that scope</li><li class="my-4 text-gray-800 dark:text-gray-300">Set the default <code class="text-gray-700 bg-gray-200 rounded dark:bg-gray-800 dark:text-gray-300" style="padding:2px 6px">NPM_TOKEN</code> to a token that can publish to that scope (this is used for any pull request)</li><li class="my-4 text-gray-800 dark:text-gray-300">Set up a <code class="text-gray-700 bg-gray-200 rounded dark:bg-gray-800 dark:text-gray-300" style="padding:2px 6px">secure</code> token that is only accessible on the main fork (still named <code class="text-gray-700 bg-gray-200 rounded dark:bg-gray-800 dark:text-gray-300" style="padding:2px 6px">NPM_TOKEN</code>)</li></ol><p class="my-4 text-gray-800 dark:text-gray-300">Step 3 might not be possible on your build platform.</p><p class="my-4 text-gray-800 dark:text-gray-300">The following are the ways the <code class="text-gray-700 bg-gray-200 rounded dark:bg-gray-800 dark:text-gray-300" style="padding:2px 6px">auto</code> team knows how to do it.
If you do not see the method for you build platform, please make a pull request!</p><ul class="my-6 ul"><li class="my-4 text-gray-800 dark:text-gray-300"><a class="underline cursor-pointer text-gray-800 dark:text-gray-300" href="https://circleci.com/docs/2.0/contexts/">CircleCI Context</a> - Contexts provide a mechanism for securing and sharing environment variables across projects. The environment variables are defined as name/value pairs and are injected at runtime.</li></ul><h2 class="lvl2 relative text-3xl font-normal border-b border-gray-300 pb-4 mb-8 mt-12 dark:border-gray-700 text-gray-900 dark:text-gray-200" id="usage"><a class="header-link no-underline text-gray-900&quot; hover:underline" href="#usage">Usage</a></h2><p class="my-4 text-gray-800 dark:text-gray-300">To use this work flow in <code class="text-gray-700 bg-gray-200 rounded dark:bg-gray-800 dark:text-gray-300" style="padding:2px 6px">auto</code>, supply the following configuration to the <code class="text-gray-700 bg-gray-200 rounded dark:bg-gray-800 dark:text-gray-300" style="padding:2px 6px">npm</code> plugin.</p><pre class="language-json my-4 bg-gray-200 rounded dark:bg-gray-800"><code class="language-json text-gray-600 rounded block py-4 px-2 dark:bg-gray-800"><span class="token punctuation">{</span>
  <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
      <span class="token string">&quot;npm&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;canaryScope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@auto-canary&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><p class="my-4 text-gray-800 dark:text-gray-300">Now when people make pull requests to your repos:</p><ol class="my-6 ol"><li class="my-4 text-gray-800 dark:text-gray-300">your CI can run <code class="text-gray-700 bg-gray-200 rounded dark:bg-gray-800 dark:text-gray-300" style="padding:2px 6px">auto shipit</code></li><li class="my-4 text-gray-800 dark:text-gray-300">the canary versions will get published under your <code class="text-gray-700 bg-gray-200 rounded dark:bg-gray-800 dark:text-gray-300" style="padding:2px 6px">canaryScope</code></li></ol></article></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blog/npm-canary-scope","query":{},"buildId":"hUHIRsB3kRewdeO8JZHuh","assetPrefix":"/auto","runtimeConfig":{"assetPrefix":"/auto"},"nextExport":true,"autoExport":true,"isFallback":false}</script><script nomodule="" src="/auto/_next/static/runtime/polyfills-a93d757db8ae2a665323.js"></script><script async="" data-next-page="/_app" src="/auto/_next/static/hUHIRsB3kRewdeO8JZHuh/pages/_app.js"></script><script async="" data-next-page="/blog/npm-canary-scope" src="/auto/_next/static/hUHIRsB3kRewdeO8JZHuh/pages/blog/npm-canary-scope.js"></script><script src="/auto/_next/static/runtime/webpack-c212667a5f965e81e004.js" async=""></script><script src="/auto/_next/static/chunks/framework.00c128824b7f421d9465.js" async=""></script><script src="/auto/_next/static/chunks/c0d60241.215143c264d3a1b830ef.js" async=""></script><script src="/auto/_next/static/chunks/fc57ec0e.f6541c4d9d596c2aef75.js" async=""></script><script src="/auto/_next/static/chunks/90ae4d623e43c2d3c5725a46451f3e6f5a5d945c.d1f24c5f6b2ef3a4bdd5.js" async=""></script><script src="/auto/_next/static/chunks/d7217cfdc2748b34172f813efa92e4207d39b759.d4bcde477e4fd173240e.js" async=""></script><script src="/auto/_next/static/chunks/8588f75bc776c9da618c7380ed92079ffdadc2a6.bca1fd0253a81db7d0c5.js" async=""></script><script src="/auto/_next/static/chunks/f09385b2ddc110a5a4c66d0b3055261d96711bfa.3bab86f518789fc7d1b9.js" async=""></script><script src="/auto/_next/static/chunks/35a5a53e27ffb1834d727be2d63ceac929300aa9.84e77ed39b387b80f63b.js" async=""></script><script src="/auto/_next/static/runtime/main-efba08c5bc5b06864400.js" async=""></script><script src="/auto/_next/static/chunks/89db983f2c4b9451dcd29b173f3ed16227e1f88d.0199175a2d64b0ba10d8.js" async=""></script><script src="/auto/_next/static/hUHIRsB3kRewdeO8JZHuh/_buildManifest.js" async=""></script><script src="/auto/_next/static/hUHIRsB3kRewdeO8JZHuh/_ssgManifest.js" async=""></script></body></html>